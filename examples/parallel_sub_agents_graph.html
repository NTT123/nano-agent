<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Node Graph Viewer</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/@dagrejs/dagre@1.0.4/dist/dagre.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #1a1a2e; color: #eee; }
#breadcrumb { background: #0f0f23; border-bottom: 1px solid #333; padding: 10px 20px; display: flex; align-items: center; gap: 8px; min-height: 44px; }
#breadcrumb .crumb { color: #888; cursor: pointer; padding: 4px 10px; border-radius: 4px; font-size: 13px; transition: all 0.2s; }
#breadcrumb .crumb:hover { background: #1a1a3e; color: #fff; }
#breadcrumb .crumb.active { background: #ff9800; color: #000; font-weight: 600; cursor: default; }
#breadcrumb .sep { color: #555; font-size: 14px; }
#breadcrumb .hint { color: #666; font-size: 11px; margin-left: auto; font-style: italic; }
#main-container { flex: 1; display: flex; overflow: hidden; }
#graph { flex: 1; overflow: hidden; }
#detail { width: 400px; background: #16213e; border-left: 1px solid #333; overflow-y: auto; display: none; }
#detail.active { display: block; }
#detail-header { padding: 15px; background: #1a1a2e; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
#detail-header h3 { font-size: 14px; color: #888; }
#detail-close { background: none; border: none; color: #888; font-size: 20px; cursor: pointer; }
#detail-close:hover { color: #fff; }
#detail-content { padding: 15px; }
.detail-section { margin-bottom: 20px; }
.detail-section h4 { font-size: 11px; text-transform: uppercase; color: #666; margin-bottom: 8px; letter-spacing: 1px; }
.detail-section pre { background: #0f0f23; padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto; white-space: pre-wrap; word-break: break-word; }
.detail-section .value { background: #0f0f23; padding: 8px 12px; border-radius: 6px; font-size: 13px; }
.tools-list { background: #0f0f23; border-radius: 6px; padding: 8px 0; }
.tool-item { padding: 8px 12px; border-bottom: 1px solid #1a1a2e; }
.tool-item:last-child { border-bottom: none; }
.tool-name { color: #d9944a; font-weight: 600; font-size: 14px; margin-bottom: 6px; }
.tool-desc { color: #ccc; font-size: 12px; margin-top: 4px; line-height: 1.5; white-space: pre-wrap; }
.tool-schema { margin-top: 10px; }
.tool-schema .schema-label { color: #666; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
.tool-schema pre { margin-top: 4px; font-size: 11px; background: #0a0a1a; padding: 10px; border-radius: 4px; }
.content-block { margin-bottom: 12px; border-radius: 6px; overflow: hidden; }
.content-block:last-child { margin-bottom: 0; }
.block-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; padding: 6px 10px; font-weight: 600; }
.block-content { padding: 10px; font-size: 12px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
.content-text { background: #0f0f23; }
.content-text .block-label { background: #1a1a3e; color: #888; }
.content-text .block-content { color: #eee; }
.content-thinking { background: #1a1a0f; border: 1px solid #3d3d1a; }
.content-thinking .block-label { background: #2d2d1a; color: #d4c057; }
.content-thinking .block-content { color: #c9b84c; font-style: italic; }
.content-tool-use { background: #0f1a1a; border: 1px solid #1a3d3d; }
.content-tool-use .block-label { background: #1a2d2d; color: #57b4d4; }
.content-tool-use .block-content { color: #4cc9c9; }
.content-tool-result { background: #0f1a0f; border: 1px solid #1a3d1a; }
.content-tool-result .block-label { background: #1a2d1a; color: #57d457; }
.content-tool-result .block-content { color: #4cc94c; }
.content-system { background: #0f1a2a; border: 1px solid #1a3d5d; }
.content-system .block-label { background: #1a2d4d; color: #5794d4; }
.content-system .block-content { color: #8ab4e8; }
.content-user { background: #0f2a1a; border: 1px solid #1a5d3d; }
.content-user .block-label { background: #1a4d2d; color: #57d494; }
.content-user .block-content { color: #8ae8b4; }
.content-tool-exec { background: #2a1a0f; border: 1px solid #5d3d1a; }
.content-tool-exec .block-label { background: #4d2d1a; color: #d49457; }
.content-tool-exec .block-content { color: #e8b48a; }
.node { cursor: pointer; }
.node rect { stroke-width: 2px; }
.node text { font-size: 11px; fill: #333; }
.node.selected rect { stroke: #ffd700 !important; stroke-width: 3px; }
.edge { fill: none; stroke: #555; stroke-width: 2px; }
.edge-arrow { fill: #555; }
.type-system_prompt rect { fill: #e6f3ff; stroke: #4a90d9; }
.type-tool_definitions rect { fill: #fff3e6; stroke: #d9944a; }
.type-message_user rect { fill: #e6ffe6; stroke: #4ad94a; }
.type-message_assistant rect { fill: #f5f5f5; stroke: #888; }
.type-tool_exec rect { fill: #fff0e6; stroke: #d97a4a; }
.type-dict rect { fill: #ffe6f3; stroke: #d94a90; }
.type-stop_reason rect { fill: #ff5555; stroke: #ff0000; }
.type-stop_reason text { fill: #fff !important; font-weight: bold; }
/* SubGraph nodes: dashed border, clickable indicator */
.type-sub_graph rect { fill: #fff3e0; stroke: #ff9800; stroke-dasharray: 5,3; }
.type-sub_graph text { fill: #e65100 !important; font-weight: bold; }
.type-sub_graph:hover rect { stroke-width: 3px; }
/* Zoom button styles */
.zoom-btn { background: #ff9800; color: #000; border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.2s; }
.zoom-btn:hover { background: #ffa726; transform: translateY(-1px); }
.zoom-btn.zoom-out { background: #666; color: #fff; }
.zoom-btn.zoom-out:hover { background: #888; }
svg { width: 100%; height: 100%; }
</style>
</head>
<body>
<div id="breadcrumb">
  <span class="crumb active">Main</span>
  <span class="hint">Click SubGraph nodes for zoom button</span>
</div>
<div id="main-container">
<div id="graph"></div>
<div id="detail">
  <div id="detail-header">
    <h3>NODE DETAILS</h3>
    <button id="detail-close">&times;</button>
  </div>
  <div id="detail-content"></div>
</div>
</div>

<script>
const graphData = {
  "meta": {
    "session_id": "parallel_sub_agents_demo",
    "created_at": 1769844264.142474
  },
  "nodes": [
    {
      "id": "90d4a93592e7",
      "type": "system_prompt",
      "label": "SYSTEM",
      "timestamp": 1769844226.703661,
      "metadata": {},
      "data": {
        "type": "system_prompt",
        "content": "You are a helpful assistant with access to security and documentation tools.\n\nIMPORTANT: When asked to perform multiple analyses, you MUST call all the tools\nin a SINGLE response (parallel tool calls). Do NOT call them sequentially."
      },
      "parent_count": 0
    },
    {
      "id": "4c87c3baf1a4",
      "type": "tool_definitions",
      "label": "TOOLS (2)",
      "timestamp": 1769844226.703682,
      "metadata": {},
      "data": {
        "type": "tool_definitions",
        "tools": [
          {
            "name": "SecurityAudit",
            "description": "Spawn a sub-agent to audit code for security vulnerabilities",
            "input_schema": {
              "type": "object",
              "properties": {
                "file_path": {
                  "type": "string",
                  "description": "Path to the file to audit for security issues"
                }
              },
              "required": [
                "file_path"
              ],
              "additionalProperties": false
            }
          },
          {
            "name": "DocSummary",
            "description": "Spawn a sub-agent to summarize code documentation and comments",
            "input_schema": {
              "type": "object",
              "properties": {
                "file_path": {
                  "type": "string",
                  "description": "Path to the file to summarize documentation for"
                }
              },
              "required": [
                "file_path"
              ],
              "additionalProperties": false
            }
          }
        ]
      },
      "parent_count": 1
    },
    {
      "id": "89e125b27c0a",
      "type": "message_user",
      "label": "USER: Analyze the file exa",
      "timestamp": 1769844226.70369,
      "metadata": {},
      "data": {
        "role": "user",
        "content": "Analyze the file examples/hello_world.py:\n1. Perform a security audit using the SecurityAudit tool\n2. Summarize the documentation using the DocSummary tool\n\nCall BOTH tools in your response."
      },
      "parent_count": 1
    },
    {
      "id": "ccecfc274881",
      "type": "message_assistant",
      "label": "ASST: \u2190result I'll analyze",
      "timestamp": 1769844231.1313121,
      "metadata": {},
      "data": {
        "role": "assistant",
        "content": [
          {
            "type": "thinking",
            "thinking": "The user wants me to analyze a file using both the SecurityAudit and DocSummary tools. Since these two analyses are independent of each other, I should call both tools in parallel in a single response.",
            "signature": "EvICCkYICxgCKkC1/WWfCHGE3E7wjybrqPxdYiCBPa8kWkCSwDBdS3nRJZ5LlvVoFSVdP74Os6eYnHuix6i5w80v4ExCDXGehGHhEgwYqtFPDwTXfIO668QaDPTMWjjOBpmzFVKoUCIwrsqOQOqULlDl23dEapTzyY9IJAKWWQXYb9rOigBaDXRTeIgL2IjOpGjED0WHRHPBKtkBmxo7CbUn3mbMNTFMnWeyNR8jlHY8i/ow2Oy5laz11/iEFGwM4VDKeNI1BvJ0hRZiiLqoQDybU+tmgUOA9XxKoWxDnUTyeu2nDTSJ/VR/lLqUiGukYy7amofzVYTBFcm23ivDucyw6gXu0vEa0hlEKR+l9MEyMX2rkcTuZVEz+MPPm+sS1J7uA4Qg9VpukRZJpTaFlM/EB9489eB7vgTpsvvdB68sQThkYaTbFQm337gC0ddh5FqAo5OfPq8GDBAohAqJyUxsRViOSqqGZiEjQGvt1x84IatPWBgB"
          },
          {
            "type": "text",
            "text": "I'll analyze the file with both tools in parallel."
          },
          {
            "type": "tool_use",
            "id": "toolu_01XcJZk9UUwRvu7TgiCuMKcE",
            "name": "SecurityAudit",
            "input": {
              "file_path": "examples/hello_world.py"
            }
          },
          {
            "type": "tool_use",
            "id": "toolu_015KjVBh3jCvLgYVj9s7eK4w",
            "name": "DocSummary",
            "input": {
              "file_path": "examples/hello_world.py"
            }
          }
        ]
      },
      "parent_count": 1
    },
    {
      "id": "384cccca139a",
      "type": "sub_graph",
      "label": "\ud83d\udd04SecurityAuditor[d=1]",
      "timestamp": 1769844248.963937,
      "metadata": {},
      "data": {
        "type": "sub_graph",
        "tool_name": "SecurityAuditor",
        "tool_use_id": "subagent_9a4a8162273b",
        "system_prompt": "You are an expert security auditor. Your task is to analyze code\nfor potential security vulnerabilities.\n\nLook for:\n- Input validation issues\n- Injection vulnerabilities (SQL, command, etc.)\n- Authentication/authorization flaws\n- Sensitive data exposure\n- Insecure dependencies or practices\n\nUse the Read tool to examine the file, then provide a concise security assessment.",
        "nodes": {
          "90be404eae41": {
            "id": "90be404eae41",
            "parent_ids": [],
            "data": {
              "type": "system_prompt",
              "content": "You are an expert security auditor. Your task is to analyze code\nfor potential security vulnerabilities.\n\nLook for:\n- Input validation issues\n- Injection vulnerabilities (SQL, command, etc.)\n- Authentication/authorization flaws\n- Sensitive data exposure\n- Insecure dependencies or practices\n\nUse the Read tool to examine the file, then provide a concise security assessment."
            },
            "timestamp": 1769844231.13152,
            "metadata": {}
          },
          "85ed5261b573": {
            "id": "85ed5261b573",
            "parent_ids": [
              "90be404eae41"
            ],
            "data": {
              "type": "tool_definitions",
              "tools": [
                {
                  "name": "Read",
                  "description": "Reads a file from the local filesystem.\n\nUsage:\n- The file_path parameter must be an absolute path, not a relative path\n- Maximum 25 lines per read (use offset to paginate through larger files)\n- Output includes metadata: file path, size, total lines, range shown\n\nWorkflow for large files:\n1. First read without offset to see file overview and metadata\n2. Use Grep to find relevant line numbers for specific patterns\n3. Use offset to read focused sections (e.g., offset=100 reads lines 101-125)\n\nExamples:\n  ReadInput(file_path=\"/path/to/file.py\")              # Lines 1-25\n  ReadInput(file_path=\"/path/to/file.py\", offset=100)  # Lines 101-125\n  ReadInput(file_path=\"/path/to/file.py\", offset=50, limit=10)  # Lines 51-60\n\nNote: For binary files (images, PDFs), content is processed differently.",
                  "input_schema": {
                    "type": "object",
                    "properties": {
                      "file_path": {
                        "type": "string",
                        "description": "The absolute path to the file to read"
                      },
                      "offset": {
                        "type": "integer",
                        "description": "The line number to start reading from"
                      },
                      "limit": {
                        "type": "integer",
                        "description": "The number of lines to read"
                      }
                    },
                    "required": [
                      "file_path"
                    ],
                    "additionalProperties": false
                  }
                }
              ]
            },
            "timestamp": 1769844231.131538,
            "metadata": {}
          },
          "abf19b16ff39": {
            "id": "abf19b16ff39",
            "parent_ids": [
              "85ed5261b573"
            ],
            "data": {
              "role": "user",
              "content": "Perform a security audit on: examples/hello_world.py"
            },
            "timestamp": 1769844231.131549,
            "metadata": {}
          },
          "7b7713d43fc3": {
            "id": "7b7713d43fc3",
            "parent_ids": [
              "abf19b16ff39"
            ],
            "data": {
              "role": "assistant",
              "content": [
                {
                  "type": "thinking",
                  "thinking": "The user wants me to perform a security audit on a specific file. Let me read the file first to examine its contents.",
                  "signature": "Ep4CCkYICxgCKkCVR7Rlr+Rxy+YN7ymTtj8r7lf8UqvYloL9g0qWkXoOPqeqgDi/LnB1JDZHg2IDRPcvl+d+93UTTW/Xd92zJpGDEgx6p2R7aNBTwlx6hLwaDN9JHtfTgrL5TogfuyIw66tQhyhwy6dCLVmV20hbF0h1gkS5nRkZQtRSrMMYOlbpP3H/3LCIgfCtRoFfT60EKoUBVR8nnvITJ1ZvXU6vzUXhQByBPLiPRp2RbLJISEqjuxoDqpBaw+LTSbWxmJvGnYBRYntFiBIm4Kk7FXhKluV3pfJasFathORfSUWMtYVXSxKQi3d/VPFYq98iolamJkrvf65Ez/uBjJEq5TKuQQ2UUkysTCBY8GIcX2PuekllRvtTBb41uRgB"
                },
                {
                  "type": "tool_use",
                  "id": "toolu_01QjwYP9hrtQLUvU1Xv1X9Gv",
                  "name": "Read",
                  "input": {
                    "file_path": "/Users/tanthong/nano-agent/examples/hello_world.py"
                  }
                }
              ]
            },
            "timestamp": 1769844234.016921,
            "metadata": {}
          },
          "96a0c3d36aa0": {
            "id": "96a0c3d36aa0",
            "parent_ids": [
              "7b7713d43fc3"
            ],
            "data": {
              "type": "tool_execution",
              "tool_name": "Read",
              "tool_use_id": "toolu_01QjwYP9hrtQLUvU1Xv1X9Gv",
              "result": [
                {
                  "type": "text",
                  "text": "Size: 406 B | Lines: 19 | Showing: 1-19\n     1\t\"\"\"Hello World: Simplest possible DAG example.\"\"\"\n     2\t\n     3\timport asyncio\n     4\t\n     5\tfrom nano_agent import DAG, ClaudeAPI\n     6\t\n     7\t\n     8\tasync def main() -> None:\n     9\t    dag = (\n    10\t        DAG().system(\"You are a friendly assistant.\").user(\"Hello! What is your name?\")\n    11\t    )\n    12\t    api = ClaudeAPI()\n    13\t    response = await api.send(dag)\n    14\t    dag = dag.assistant(response.content)\n    15\t    print(dag)\n    16\t\n    17\t\n    18\tif __name__ == \"__main__\":\n    19\t    asyncio.run(main())"
                }
              ],
              "is_error": false
            },
            "timestamp": 1769844234.018851,
            "metadata": {}
          },
          "b9c9d03154f4": {
            "id": "b9c9d03154f4",
            "parent_ids": [
              "96a0c3d36aa0"
            ],
            "data": {
              "role": "user",
              "content": [
                {
                  "type": "tool_result",
                  "tool_use_id": "toolu_01QjwYP9hrtQLUvU1Xv1X9Gv",
                  "content": [
                    {
                      "type": "text",
                      "text": "Size: 406 B | Lines: 19 | Showing: 1-19\n     1\t\"\"\"Hello World: Simplest possible DAG example.\"\"\"\n     2\t\n     3\timport asyncio\n     4\t\n     5\tfrom nano_agent import DAG, ClaudeAPI\n     6\t\n     7\t\n     8\tasync def main() -> None:\n     9\t    dag = (\n    10\t        DAG().system(\"You are a friendly assistant.\").user(\"Hello! What is your name?\")\n    11\t    )\n    12\t    api = ClaudeAPI()\n    13\t    response = await api.send(dag)\n    14\t    dag = dag.assistant(response.content)\n    15\t    print(dag)\n    16\t\n    17\t\n    18\tif __name__ == \"__main__\":\n    19\t    asyncio.run(main())"
                    }
                  ],
                  "is_error": false
                }
              ]
            },
            "timestamp": 1769844234.018879,
            "metadata": {}
          },
          "2b898cfeeca9": {
            "id": "2b898cfeeca9",
            "parent_ids": [
              "b9c9d03154f4"
            ],
            "data": {
              "role": "assistant",
              "content": [
                {
                  "type": "thinking",
                  "thinking": "This is a simple example file that demonstrates basic usage of the nano_agent library. Let me analyze it for security vulnerabilities.\n\nThe code:\n1. Creates a DAG with a system prompt and user message\n2. Uses ClaudeAPI to send the request\n3. Appends the assistant response to the DAG\n4. Prints the DAG\n\nSecurity analysis:\n\n1. **Input validation**: The user message is hardcoded (\"Hello! What is your name?\"), so there's no external input being processed directly in this file.\n\n2. **Injection vulnerabilities**: No SQL, command injection, or other injection vectors are present since there's no external input being passed to commands or queries.\n\n3. **Authentication/authorization**: The ClaudeAPI() is instantiated without visible credentials in this file. The API key is likely read from environment variables or a config file by the ClaudeAPI class itself. This is actually a good practice - not hardcoding credentials.\n\n4. **Sensitive data exposure**: No sensitive data is hardcoded or exposed in this example.\n\n5. **Insecure dependencies**: The code imports from `nano_agent` which is the local library. No obvious insecure third-party dependencies.\n\n6. **Other concerns**: None significant.\n\nThis is a minimal \"hello world\" example with no significant security concerns. It's a demonstration file with hardcoded, benign inputs.",
                  "signature": "Et8LCkYICxgCKkDtWK53HlrlFb4AxOYpmsBEYnX3rIlL5urFinPYxpYvNVY5Tkx3TSFe5Y7rizzWMqe9MVyVhot3Qlm/C7otfHyQEgzxCIrKLGUU1cBeCkgaDEfgPmqogjL/SHuPxiIwQjpie7o+ZUuoZo/pSMc/4G+BxqLPiePbJ0KF5zTV/vJ24lhdyXTs9JVs8I5HQtWNKsYKKUKXdBo06s3YQ/eTCEDNfciKVN0/BFtNICquz6nNlruvDGyGNrxxV6KZAckWXHKPM/Jd2d9+Oj4DwtUbSlICrjhApZ6ijCntkMxr+tn8Lqz7B/wxz7uzwJWa16nTgzlXOS11XjQFplwZ8kTYPkQyeEgijdVyOGhdPU+9oXE0ZcIVG3I+K4kR4o919rKX8LxLKaH9/S//goIzpR4GOZRvKm0X0vivq2WBOELm9oEGMj5FKmQBX7Vlr3Q9eVtfxH4EBmCFsQAfLPdq2QWHHgea6IlCpEOLeyX8PnBR6VtuFPsMd+KfQ9ArtxFfKFS+ztP+zufYWuQp4twcelmJNls2KUzJAYVs1ix/6Y7N3XVLxQar6Ho3EbAwliSq6vVTVPbxVOvkyhp+4k3H/vMJycDGavSJVfVRdYoMsHjrJoZrgjBYUiABcNoPlDGVJkxTTCEzbsIHsV/g6pLj80iFkLJuv7Ewy+J4Qm6lgM0MyvklWvleuDZDWJje1M/tLOb90mDZu2ZbqCy7xdgC6PCl8vxw9kWo1yIRHlLLmkSVxAQ6KXbYVrlvu8wqIcQ6aFEYx5EVU/db2SaYjIs8PN9QrXVpLLbv/NIcKJp/WizfvVsCu3Xe/mx2LDxSQVFAfygnRUGni7jFdX7W42xvuwC0lo2/gIEHX+VFte6Rl6DOWaNfpxwOqNndPygnzNptULZllDSuRE5gdClP0FiuYOYmWXMkWxoLg9fm3XcK2aGWuLZBWSJpVsablWBJG7v2YwW5MMouIzaZA+xGOnOCU/E6wSo6Z962TbEQmL5WKo6wKklziE+meV6xI30gZ8fD30VgJIBLEoaAWeRET7SLTNyM5zdl8xi7Gy06z88+OAoeEY8+yTVp7YgU1lAyUWjtnyuAcSB6hiRWCHGPuXPhGA7TDMbF2QhP/jCnaQ4Zt1WtlTkxR4t0+PftCZgDYIOX6b4a6t+cndoWUfkPazPKZ4OU5HbHSuSWTBR4R/AGoIqscDxCyMuRvaMD+M5V5qzd/u2IPRRo40Ba8udrAdm4oCipexVMSiqjvojaF9/B500A6e/RIMxnYudHShRgsAX5p0iku2T12gapOZCwO5H7ozEs5EUguix3JPtOgY09RdIpa/LMFH4cywcUvA+BlFLMB2vvjrLHfevhopTNUIQ2bJ721D+CJhkviZxqghRU8y7rHenfHV45D0QXUcFpSresmiqjbX3uURGFU7KBmK5vkILxM+sMifD5DbnBmr7W6s6Z2bhyAXUfd0EZ/YcwEYucwr5SfPCJzMG5prSWnoq60iD/l9gHEZMtb2DOhVdqZRppmz9pUxRjbV2Lzzta2oVIj5tlo9oY3AVNbSVpG4F9Pi7lzjFBHtm4mzOeUdU8qwtOH1Fi3eVDycrPWtjflpnGO/zfl3ULB/6P8DoqaTYkC5vbOzZEeC/AqFaxv6P0pYlMOtBrnnAW0qlUpBIXe4Blpfdph9eF5DsaUVqR1GK8PNxfaaetA084MVhWVHBX34BJyBnwFrGYMZgMWOEvg6dr4K3cvsVeleGbeBQua/e0qS9IlWRAc9O7mDl+Vh1c8fiE8j1/yEuZqDL5Al8SDjOeWthcfHuF3nMf583H6v6CZpo9G17ZU2P92TXPlmpt7F7nZ5rbauWNme0J+nlBNo43MumPasY0CfY+4XOx5XYiXxTqrTkPNOf17U/63VUBGAuU2xaZkGkWNLn3D4B1x9VA4apAXFyLaZm8dwp++U5p9DkBouD9RB44m0tCJL/DMufR4IZQ28iLv/Ia1gdVoIvwdk5qhX5kSejojAuWGAE="
                },
                {
                  "type": "text",
                  "text": "## Security Audit: `examples/hello_world.py`\n\n### Summary: **Low Risk** \u2713\n\nThis is a minimal example file with no significant security vulnerabilities.\n\n### Analysis\n\n| Category | Status | Notes |\n|----------|--------|-------|\n| Input Validation | \u2713 Safe | All inputs are hardcoded strings, no external/user input |\n| Injection Vulnerabilities | \u2713 Safe | No dynamic queries, commands, or string interpolation with external data |\n| Authentication | \u2713 Safe | No credentials hardcoded; `ClaudeAPI()` presumably reads from environment variables |\n| Sensitive Data Exposure | \u2713 Safe | No secrets, tokens, or PII in the code |\n| Insecure Dependencies | \u2713 Safe | Only imports local `nano_agent` library and standard `asyncio` |\n\n### Details\n\nThe file is a straightforward demonstration:\n- Uses hardcoded system prompt and user message\n- No file I/O, network calls beyond the API, or subprocess execution\n- Output is simply printed to stdout\n\n### Recommendations\n\nNone required for this example file. If this pattern were extended to accept user input:\n1. Validate and sanitize any user-provided prompts before passing to the API\n2. Consider rate limiting if exposed as a service\n3. Be mindful of prompt injection if user input is concatenated with system prompts"
                }
              ]
            },
            "timestamp": 1769844248.9638,
            "metadata": {}
          },
          "2868ab4802c3": {
            "id": "2868ab4802c3",
            "parent_ids": [
              "2b898cfeeca9"
            ],
            "data": {
              "type": "stop_reason",
              "reason": "end_turn",
              "usage": {
                "input_tokens": 8770,
                "output_tokens": 737,
                "cache_creation_input_tokens": 0,
                "cache_read_input_tokens": 0
              }
            },
            "timestamp": 1769844248.96382,
            "metadata": {}
          }
        },
        "head_ids": [
          "2868ab4802c3"
        ],
        "summary": "## Security Audit: `examples/hello_world.py`\n\n### Summary: **Low Risk** \u2713\n\nThis is a minimal example file with no significant security vulnerabilities.\n\n### Analysis\n\n| Category | Status | Notes |\n|----------|--------|-------|\n| Input Validation | \u2713 Safe | All inputs are hardcoded strings, no external/user input |\n| Injection Vulnerabilities | \u2713 Safe | No dynamic queries, commands, or string interpolation with external data |\n| Authentication | \u2713 Safe | No credentials hardcoded; `ClaudeAPI()` pr...",
        "depth": 1
      },
      "parent_count": 1
    },
    {
      "id": "6d18be8ad0fe",
      "type": "tool_exec",
      "label": "\u26a1SecurityAudit",
      "timestamp": 1769844248.9639459,
      "metadata": {},
      "data": {
        "type": "tool_execution",
        "tool_name": "SecurityAudit",
        "tool_use_id": "toolu_01XcJZk9UUwRvu7TgiCuMKcE",
        "result": [
          {
            "type": "text",
            "text": "Security Audit Complete\nFile: examples/hello_world.py\n---\n## Security Audit: `examples/hello_world.py`\n\n### Summary: **Low Risk** \u2713\n\nThis is a minimal example file with no significant security vulnerabilities.\n\n### Analysis\n\n| Category | Status | Notes |\n|----------|--------|-------|\n| Input Validation | \u2713 Safe | All inputs are hardcoded strings, no external/user input |\n| Injection Vulnerabilities | \u2713 Safe | No dynamic queries, commands, or string interpolation with external data |\n| Authentication | \u2713 Safe | No credentials hardcoded; `ClaudeAPI()` pr..."
          }
        ],
        "is_error": false
      },
      "parent_count": 1
    },
    {
      "id": "3787c7e3c433",
      "type": "sub_graph",
      "label": "\ud83d\udd04DocSummarizer[d=1]",
      "timestamp": 1769844257.997899,
      "metadata": {},
      "data": {
        "type": "sub_graph",
        "tool_name": "DocSummarizer",
        "tool_use_id": "subagent_7b249cf9bc4f",
        "system_prompt": "You are an expert technical writer. Your task is to summarize\nthe documentation and comments in code files.\n\nProvide:\n- Overview of what the code does\n- Summary of docstrings and comments\n- Description of key functions/classes\n- Any usage examples found in the code\n\nUse the Read tool to examine the file, then provide a concise documentation summary.",
        "nodes": {
          "4f033922af0a": {
            "id": "4f033922af0a",
            "parent_ids": [],
            "data": {
              "type": "system_prompt",
              "content": "You are an expert technical writer. Your task is to summarize\nthe documentation and comments in code files.\n\nProvide:\n- Overview of what the code does\n- Summary of docstrings and comments\n- Description of key functions/classes\n- Any usage examples found in the code\n\nUse the Read tool to examine the file, then provide a concise documentation summary."
            },
            "timestamp": 1769844248.9641972,
            "metadata": {}
          },
          "6fb1702532af": {
            "id": "6fb1702532af",
            "parent_ids": [
              "4f033922af0a"
            ],
            "data": {
              "type": "tool_definitions",
              "tools": [
                {
                  "name": "Read",
                  "description": "Reads a file from the local filesystem.\n\nUsage:\n- The file_path parameter must be an absolute path, not a relative path\n- Maximum 25 lines per read (use offset to paginate through larger files)\n- Output includes metadata: file path, size, total lines, range shown\n\nWorkflow for large files:\n1. First read without offset to see file overview and metadata\n2. Use Grep to find relevant line numbers for specific patterns\n3. Use offset to read focused sections (e.g., offset=100 reads lines 101-125)\n\nExamples:\n  ReadInput(file_path=\"/path/to/file.py\")              # Lines 1-25\n  ReadInput(file_path=\"/path/to/file.py\", offset=100)  # Lines 101-125\n  ReadInput(file_path=\"/path/to/file.py\", offset=50, limit=10)  # Lines 51-60\n\nNote: For binary files (images, PDFs), content is processed differently.",
                  "input_schema": {
                    "type": "object",
                    "properties": {
                      "file_path": {
                        "type": "string",
                        "description": "The absolute path to the file to read"
                      },
                      "offset": {
                        "type": "integer",
                        "description": "The line number to start reading from"
                      },
                      "limit": {
                        "type": "integer",
                        "description": "The number of lines to read"
                      }
                    },
                    "required": [
                      "file_path"
                    ],
                    "additionalProperties": false
                  }
                }
              ]
            },
            "timestamp": 1769844248.96421,
            "metadata": {}
          },
          "8f62ed9212fd": {
            "id": "8f62ed9212fd",
            "parent_ids": [
              "6fb1702532af"
            ],
            "data": {
              "role": "user",
              "content": "Summarize the documentation in: examples/hello_world.py"
            },
            "timestamp": 1769844248.964221,
            "metadata": {}
          },
          "a95b51705d66": {
            "id": "a95b51705d66",
            "parent_ids": [
              "8f62ed9212fd"
            ],
            "data": {
              "role": "assistant",
              "content": [
                {
                  "type": "thinking",
                  "thinking": "The user wants me to summarize the documentation in the file examples/hello_world.py. Let me read that file first.",
                  "signature": "EpsCCkYICxgCKkAC2yrlsIaBWUm3iQeJGcw0nVAg6MIxjEIfvTM1au72TTDrkmN+CkQyE9DGzivWRKRzMcy1bYqBAZWVkG8hzJBeEgweGtT41kmoscxw6koaDGTH/5hTm9MfXWgfNyIwrMFf7J/al/0d8y552jsR34BAXIaX9xqSIRZkKiXuL61B/8EB5XnCcckpUdveJHOFKoIB7eXq9xy2KPgOlx62E6wcxcUOSdMEPK7hC2odoeUxTRgmqS43MISqJRhtYlk8WJ4mQEl4/gmzN/AgA5ij3eHfFYVi8grAu/tsYW5FGvEFAazbWEoZGprSiomaCZjRYW2BFYOXTWujrawAMj4CnWoHwnkvNc71Ikd0wd01WNSsef0z3RgB"
                },
                {
                  "type": "tool_use",
                  "id": "toolu_01UVk2kX4nJtVtdfhJMEVpyy",
                  "name": "Read",
                  "input": {
                    "file_path": "/Users/tanthong/nano-agent/examples/hello_world.py"
                  }
                }
              ]
            },
            "timestamp": 1769844251.387747,
            "metadata": {}
          },
          "1629906cefe8": {
            "id": "1629906cefe8",
            "parent_ids": [
              "a95b51705d66"
            ],
            "data": {
              "type": "tool_execution",
              "tool_name": "Read",
              "tool_use_id": "toolu_01UVk2kX4nJtVtdfhJMEVpyy",
              "result": [
                {
                  "type": "text",
                  "text": "Size: 406 B | Lines: 19 | Showing: 1-19\n     1\t\"\"\"Hello World: Simplest possible DAG example.\"\"\"\n     2\t\n     3\timport asyncio\n     4\t\n     5\tfrom nano_agent import DAG, ClaudeAPI\n     6\t\n     7\t\n     8\tasync def main() -> None:\n     9\t    dag = (\n    10\t        DAG().system(\"You are a friendly assistant.\").user(\"Hello! What is your name?\")\n    11\t    )\n    12\t    api = ClaudeAPI()\n    13\t    response = await api.send(dag)\n    14\t    dag = dag.assistant(response.content)\n    15\t    print(dag)\n    16\t\n    17\t\n    18\tif __name__ == \"__main__\":\n    19\t    asyncio.run(main())"
                }
              ],
              "is_error": false
            },
            "timestamp": 1769844251.389033,
            "metadata": {}
          },
          "5d37f830508f": {
            "id": "5d37f830508f",
            "parent_ids": [
              "1629906cefe8"
            ],
            "data": {
              "role": "user",
              "content": [
                {
                  "type": "tool_result",
                  "tool_use_id": "toolu_01UVk2kX4nJtVtdfhJMEVpyy",
                  "content": [
                    {
                      "type": "text",
                      "text": "Size: 406 B | Lines: 19 | Showing: 1-19\n     1\t\"\"\"Hello World: Simplest possible DAG example.\"\"\"\n     2\t\n     3\timport asyncio\n     4\t\n     5\tfrom nano_agent import DAG, ClaudeAPI\n     6\t\n     7\t\n     8\tasync def main() -> None:\n     9\t    dag = (\n    10\t        DAG().system(\"You are a friendly assistant.\").user(\"Hello! What is your name?\")\n    11\t    )\n    12\t    api = ClaudeAPI()\n    13\t    response = await api.send(dag)\n    14\t    dag = dag.assistant(response.content)\n    15\t    print(dag)\n    16\t\n    17\t\n    18\tif __name__ == \"__main__\":\n    19\t    asyncio.run(main())"
                    }
                  ],
                  "is_error": false
                }
              ]
            },
            "timestamp": 1769844251.3890471,
            "metadata": {}
          },
          "15f82e0d37c4": {
            "id": "15f82e0d37c4",
            "parent_ids": [
              "5d37f830508f"
            ],
            "data": {
              "role": "assistant",
              "content": [
                {
                  "type": "thinking",
                  "thinking": "Now I have the file contents. Let me summarize the documentation and code structure.",
                  "signature": "EvwBCkYICxgCKkCMIRlSslq3Gk9q5Botnnq5HkRCXio8O1fcmnmlfNtHEVWzAUFvRRI/yiAZV2OqXgoXzFfmgqDFb+RcI55zXEMpEgxTjhYiJwRBtA3oPGcaDPn66GmfUZyIa3zEKiIw6T0xex5vyWQhQQbhISnzR9QHz+fx50WCeGqblZMmy2PZTjIRcUl8esLyQTyssuoZKmQqls1hz0JDsOjgpcIq5eYS6uRv04P5aByQyflfM3OZ6h4Yejdi3cQxOnWFInuV3HesAjrBYzeNHsgItgeCzxSZWNztOki5zS6foxoI1qTG0jtCrr3ebeA3m1Ylcujd/lVPZiABGAE="
                },
                {
                  "type": "text",
                  "text": "## Documentation Summary: `examples/hello_world.py`\n\n### Overview\nThis is the simplest example demonstrating how to use the `nano_agent` library to create a conversational DAG (Directed Acyclic Graph) and send it to Claude's API.\n\n### Module Docstring\n> \"Hello World: Simplest possible DAG example.\"\n\n### Key Components\n\n| Component | Description |\n|-----------|-------------|\n| `DAG` | A builder class for constructing conversation flows with chained method calls |\n| `ClaudeAPI` | API client for communicating with Claude |\n\n### Code Flow\n1. Creates a `DAG` with a system prompt (\"You are a friendly assistant.\") and a user message\n2. Instantiates the `ClaudeAPI` client\n3. Sends the DAG to the API and awaits the response\n4. Appends the assistant's response to the DAG\n5. Prints the complete conversation\n\n### Usage Pattern\nThe example demonstrates the fluent/builder pattern for constructing conversations:\n```python\ndag = DAG().system(\"...\").user(\"...\")\nresponse = await api.send(dag)\ndag = dag.assistant(response.content)\n```\n\n### Entry Point\nStandard Python async entry point using `asyncio.run(main())`."
                }
              ]
            },
            "timestamp": 1769844257.997746,
            "metadata": {}
          },
          "ce3604ec0256": {
            "id": "ce3604ec0256",
            "parent_ids": [
              "15f82e0d37c4"
            ],
            "data": {
              "type": "stop_reason",
              "reason": "end_turn",
              "usage": {
                "input_tokens": 8762,
                "output_tokens": 426,
                "cache_creation_input_tokens": 0,
                "cache_read_input_tokens": 0
              }
            },
            "timestamp": 1769844257.997772,
            "metadata": {}
          }
        },
        "head_ids": [
          "ce3604ec0256"
        ],
        "summary": "## Documentation Summary: `examples/hello_world.py`\n\n### Overview\nThis is the simplest example demonstrating how to use the `nano_agent` library to create a conversational DAG (Directed Acyclic Graph) and send it to Claude's API.\n\n### Module Docstring\n> \"Hello World: Simplest possible DAG example.\"\n\n### Key Components\n\n| Component | Description |\n|-----------|-------------|\n| `DAG` | A builder class for constructing conversation flows with chained method calls |\n| `ClaudeAPI` | API client for co...",
        "depth": 1
      },
      "parent_count": 1
    },
    {
      "id": "90ed6e7137a1",
      "type": "tool_exec",
      "label": "\u26a1DocSummary",
      "timestamp": 1769844257.9979131,
      "metadata": {},
      "data": {
        "type": "tool_execution",
        "tool_name": "DocSummary",
        "tool_use_id": "toolu_015KjVBh3jCvLgYVj9s7eK4w",
        "result": [
          {
            "type": "text",
            "text": "Documentation Summary Complete\nFile: examples/hello_world.py\n---\n## Documentation Summary: `examples/hello_world.py`\n\n### Overview\nThis is the simplest example demonstrating how to use the `nano_agent` library to create a conversational DAG (Directed Acyclic Graph) and send it to Claude's API.\n\n### Module Docstring\n> \"Hello World: Simplest possible DAG example.\"\n\n### Key Components\n\n| Component | Description |\n|-----------|-------------|\n| `DAG` | A builder class for constructing conversation flows with chained method calls |\n| `ClaudeAPI` | API client for co..."
          }
        ],
        "is_error": false
      },
      "parent_count": 1
    },
    {
      "id": "e358fc029a35",
      "type": "message_user",
      "label": "USER: \u2190result \u2190result",
      "timestamp": 1769844257.997931,
      "metadata": {},
      "data": {
        "role": "user",
        "content": [
          {
            "type": "tool_result",
            "tool_use_id": "toolu_01XcJZk9UUwRvu7TgiCuMKcE",
            "content": [
              {
                "type": "text",
                "text": "Security Audit Complete\nFile: examples/hello_world.py\n---\n## Security Audit: `examples/hello_world.py`\n\n### Summary: **Low Risk** \u2713\n\nThis is a minimal example file with no significant security vulnerabilities.\n\n### Analysis\n\n| Category | Status | Notes |\n|----------|--------|-------|\n| Input Validation | \u2713 Safe | All inputs are hardcoded strings, no external/user input |\n| Injection Vulnerabilities | \u2713 Safe | No dynamic queries, commands, or string interpolation with external data |\n| Authentication | \u2713 Safe | No credentials hardcoded; `ClaudeAPI()` pr..."
              }
            ],
            "is_error": false
          },
          {
            "type": "tool_result",
            "tool_use_id": "toolu_015KjVBh3jCvLgYVj9s7eK4w",
            "content": [
              {
                "type": "text",
                "text": "Documentation Summary Complete\nFile: examples/hello_world.py\n---\n## Documentation Summary: `examples/hello_world.py`\n\n### Overview\nThis is the simplest example demonstrating how to use the `nano_agent` library to create a conversational DAG (Directed Acyclic Graph) and send it to Claude's API.\n\n### Module Docstring\n> \"Hello World: Simplest possible DAG example.\"\n\n### Key Components\n\n| Component | Description |\n|-----------|-------------|\n| `DAG` | A builder class for constructing conversation flows with chained method calls |\n| `ClaudeAPI` | API client for co..."
              }
            ],
            "is_error": false
          }
        ]
      },
      "parent_count": 2
    },
    {
      "id": "5874eea5bbba",
      "type": "message_assistant",
      "label": "ASST: \u2190result ## Analysis ",
      "timestamp": 1769844264.14239,
      "metadata": {},
      "data": {
        "role": "assistant",
        "content": [
          {
            "type": "thinking",
            "thinking": "Both tools have returned results. Let me summarize the findings for the user.",
            "signature": "EvUBCkYICxgCKkDbs3aYl2VIKIZKrrixqFWkF87Un1zWdIPnvsyBsJayvHsYZ51s92VklH40nsK2n49D9HVJDARFOcVA/Tk71HklEgydqzRs1mfcX5wkySYaDMgLFZdOIq4qh5YOwCIwCAsTpYsw1zsMMRzfGLPmSQLyFvBQ7Egg6+O0cWBAou6ZVIjvugaJ83QKKNFFRKnUKl1MloAFU+bsvaryRrqZpIOpGqQuhp5u85hfQp62CPcQDunbCDOxq4D2D9YmB+++a2/TQwaimPYwvmMjl2h2FiNAXX2OwL1RKCH9q/BF8S++DnAokhw67CY0lgaY+jQYAQ=="
          },
          {
            "type": "text",
            "text": "## Analysis Results for `examples/hello_world.py`\n\n### Security Audit: **Low Risk** \u2713\n\nThis is a minimal example file with no significant security vulnerabilities.\n\n| Category | Status | Notes |\n|----------|--------|-------|\n| Input Validation | \u2713 Safe | All inputs are hardcoded strings, no external/user input |\n| Injection Vulnerabilities | \u2713 Safe | No dynamic queries, commands, or string interpolation with external data |\n| Authentication | \u2713 Safe | No credentials hardcoded; `ClaudeAPI()` presumably loads from environment |\n\n---\n\n### Documentation Summary\n\n**Overview:** This is the simplest example demonstrating how to use the `nano_agent` library to create a conversational DAG (Directed Acyclic Graph) and send it to Claude's API.\n\n**Module Docstring:** \"Hello World: Simplest possible DAG example.\"\n\n| Component | Description |\n|-----------|-------------|\n| `DAG` | A builder class for constructing conversation flows with chained method calls |\n| `ClaudeAPI` | API client for communicating with Claude |\n\nThis file serves as a good starting point for understanding the basic usage pattern of the nano_agent library."
          }
        ]
      },
      "parent_count": 1
    },
    {
      "id": "b2a7abbc1df2",
      "type": "stop_reason",
      "label": "\u25c9 end_turn",
      "timestamp": 1769844264.142408,
      "metadata": {},
      "data": {
        "type": "stop_reason",
        "reason": "end_turn",
        "usage": {
          "input_tokens": 8607,
          "output_tokens": 479,
          "cache_creation_input_tokens": 0,
          "cache_read_input_tokens": 0
        }
      },
      "parent_count": 1
    }
  ],
  "edges": [
    {
      "source": "90d4a93592e7",
      "target": "4c87c3baf1a4"
    },
    {
      "source": "4c87c3baf1a4",
      "target": "89e125b27c0a"
    },
    {
      "source": "89e125b27c0a",
      "target": "ccecfc274881"
    },
    {
      "source": "ccecfc274881",
      "target": "384cccca139a"
    },
    {
      "source": "384cccca139a",
      "target": "6d18be8ad0fe"
    },
    {
      "source": "ccecfc274881",
      "target": "3787c7e3c433"
    },
    {
      "source": "3787c7e3c433",
      "target": "90ed6e7137a1"
    },
    {
      "source": "6d18be8ad0fe",
      "target": "e358fc029a35"
    },
    {
      "source": "90ed6e7137a1",
      "target": "e358fc029a35"
    },
    {
      "source": "e358fc029a35",
      "target": "5874eea5bbba"
    },
    {
      "source": "5874eea5bbba",
      "target": "b2a7abbc1df2"
    }
  ]
};

// Build tool_use_id -> tool_name mapping from all nodes
const toolNameMap = {};
graphData.nodes.forEach(n => {
  if (n.data && n.data.content && Array.isArray(n.data.content)) {
    n.data.content.forEach(block => {
      if (block.type === 'tool_use' && block.id && block.name) {
        toolNameMap[block.id] = block.name;
      }
    });
  }
});

const container = document.getElementById('graph');
const width = container.clientWidth;
const height = container.clientHeight;

const svg = d3.select('#graph').append('svg');
const g = svg.append('g');

// Arrow marker
svg.append('defs').append('marker')
  .attr('id', 'arrow')
  .attr('viewBox', '0 -5 10 10')
  .attr('refX', 8)
  .attr('refY', 0)
  .attr('markerWidth', 6)
  .attr('markerHeight', 6)
  .attr('orient', 'auto')
  .append('path')
  .attr('d', 'M0,-5L10,0L0,5')
  .attr('class', 'edge-arrow');

// Zoom
svg.call(d3.zoom().on('zoom', (e) => g.attr('transform', e.transform)));

// Build dagre graph
const dagreGraph = new dagre.graphlib.Graph();
dagreGraph.setGraph({ rankdir: 'TB', nodesep: 50, ranksep: 60, marginx: 20, marginy: 20 });
dagreGraph.setDefaultEdgeLabel(() => ({}));

const nodeWidth = 140, nodeHeight = 40;

// Add nodes
graphData.nodes.forEach(n => {
  dagreGraph.setNode(n.id, { width: nodeWidth, height: nodeHeight, data: n });
});

// Add edges
graphData.edges.forEach(e => {
  dagreGraph.setEdge(e.source, e.target);
});

// Layout
dagre.layout(dagreGraph);

// Get positions
const nodeMap = new Map();
dagreGraph.nodes().forEach(id => {
  const node = dagreGraph.node(id);
  node.data.x = node.x;
  node.data.y = node.y;
  nodeMap.set(id, node.data);
});

// Compute bounds and set viewBox
const xs = graphData.nodes.map(n => n.x);
const ys = graphData.nodes.map(n => n.y);
const minX = Math.min(...xs) - nodeWidth;
const maxX = Math.max(...xs) + nodeWidth;
const minY = Math.min(...ys) - nodeHeight;
const maxY = Math.max(...ys) + nodeHeight;
svg.attr('viewBox', `${minX} ${minY} ${maxX - minX} ${maxY - minY}`);

// Draw edges with curves
const edges = g.selectAll('.edge')
  .data(graphData.edges)
  .join('path')
  .attr('class', 'edge')
  .attr('marker-end', 'url(#arrow)')
  .attr('d', d => {
    const source = nodeMap.get(d.source);
    const target = nodeMap.get(d.target);
    const sy = source.y + nodeHeight/2;
    const ty = target.y - nodeHeight/2;
    const midY = (sy + ty) / 2;
    return `M${source.x},${sy} C${source.x},${midY} ${target.x},${midY} ${target.x},${ty}`;
  });

// Draw nodes
const nodes = g.selectAll('.node')
  .data(graphData.nodes)
  .join('g')
  .attr('class', d => `node type-${d.type}`)
  .attr('transform', d => `translate(${d.x - nodeWidth/2},${d.y - nodeHeight/2})`)
  .on('click', (e, d) => showDetail(d));

nodes.append('rect')
  .attr('width', nodeWidth)
  .attr('height', nodeHeight)
  .attr('rx', 6);

nodes.append('text')
  .attr('x', nodeWidth / 2)
  .attr('y', nodeHeight / 2 + 4)
  .attr('text-anchor', 'middle')
  .text(d => d.label.length > 18 ? d.label.slice(0, 16) + '...' : d.label);

// Detail panel
let selected = null;

function showDetail(node) {
  if (selected) d3.selectAll('.node').classed('selected', false);
  selected = node;
  d3.selectAll('.node').classed('selected', d => d.id === node.id);

  const detail = document.getElementById('detail');
  detail.classList.add('active');

  const content = document.getElementById('detail-content');
  content.innerHTML = buildDetailHTML(node);
}

function buildDetailHTML(node) {
  let html = '';

  html += section('Type', `<div class="value">${node.type}</div>`);
  html += section('ID', `<div class="value">${node.id}</div>`);

  // Handle different node types
  if (node.type === 'system_prompt') {
    html += section('Content', formatSystemPrompt(node.data.content));
  } else if (node.type === 'message_user') {
    html += section('Content', formatUserMessage(node.data.content));
  } else if (node.data.content !== undefined) {
    html += section('Content', formatContent(node.data.content));
  }

  // Tool execution node
  if (node.type === 'tool_exec') {
    html += section('Tool Execution', formatToolExec(node.data));
  }

  // SubGraph node
  if (node.type === 'sub_graph') {
    const nodeCount = node.data.nodes ? Object.keys(node.data.nodes).length : 0;
    html += section('Sub-Agent', `
      <div class="content-block content-tool-exec">
        <div class="block-label">üîÑ ${escapeHtml(node.data.tool_name)} (depth: ${node.data.depth || 0})</div>
        <div class="block-content">${escapeHtml(node.data.summary || '(no summary)')}</div>
      </div>
      ${nodeCount > 0 ? `<button class="zoom-btn" onclick="zoomIntoSubGraph()">üîç Zoom Into Sub-Agent (${nodeCount} nodes)</button>` : ''}
    `);
    if (node.data.system_prompt) {
      html += section('Sub-Agent System Prompt', `<div class="content-block content-system"><div class="block-content">${escapeHtml(node.data.system_prompt)}</div></div>`);
    }
  }

  // Stop reason node
  if (node.type === 'stop_reason') {
    html += section('Stop Reason', `<div class="value" style="color: #ff5555; font-weight: bold;">${escapeHtml(node.data.reason)}</div>`);
    if (node.data.usage) {
      const u = node.data.usage;
      const total_input = u.input_tokens || 0;
      const total_output = u.output_tokens || 0;
      const cached = u.cache_read_input_tokens || 0;
      const cache_write = u.cache_creation_input_tokens || 0;
      html += section('Total Usage', `
        <div class="value">
          <div><strong>Input:</strong> ${total_input.toLocaleString()} tokens ${cached > 0 ? `(${cached.toLocaleString()} cached)` : ''}</div>
          <div><strong>Output:</strong> ${total_output.toLocaleString()} tokens</div>
          ${cache_write > 0 ? `<div><strong>Cache writes:</strong> ${cache_write.toLocaleString()} tokens</div>` : ''}
          <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #333;"><strong>Total:</strong> ${(total_input + total_output).toLocaleString()} tokens</div>
        </div>
      `);
    }
  }

  if (node.data.tools) {
    const toolsHtml = node.data.tools.map(t => {
      let itemHtml = `<div class="tool-item">`;
      itemHtml += `<div class="tool-name">${escapeHtml(t.name)}</div>`;
      if (t.description) {
        itemHtml += `<div class="tool-desc">${escapeHtml(t.description)}</div>`;
      }
      if (t.input_schema) {
        itemHtml += `<div class="tool-schema"><span class="schema-label">Input Schema:</span><pre>${escapeHtml(JSON.stringify(t.input_schema, null, 2))}</pre></div>`;
      }
      itemHtml += `</div>`;
      return itemHtml;
    }).join('');
    html += section('Tools', `<div class="tools-list">${toolsHtml}</div>`);
  }

  if (Object.keys(node.metadata).length > 0) {
    html += section('Metadata', `<pre>${escapeHtml(JSON.stringify(node.metadata, null, 2))}</pre>`);
  }

  html += section('Raw Data', `<pre>${escapeHtml(JSON.stringify(node.data, null, 2))}</pre>`);

  return html;
}

function section(title, content) {
  return `<div class="detail-section"><h4>${title}</h4>${content}</div>`;
}

function formatSystemPrompt(content) {
  return `<div class="content-block content-system"><div class="block-label">System Prompt</div><div class="block-content">${escapeHtml(content)}</div></div>`;
}

function formatUserMessage(content) {
  if (typeof content === 'string') {
    return `<div class="content-block content-user"><div class="block-label">User</div><div class="block-content">${escapeHtml(content)}</div></div>`;
  }
  // If array (e.g., tool results), format each block
  if (Array.isArray(content)) {
    return content.map(block => {
      if (block.type === 'tool_result') {
        const toolName = toolNameMap[block.tool_use_id] || '';
        const label = toolName ? `‚Üê ${toolName}` : 'Tool Result';
        const resultContent = extractText(block.content);
        return `<div class="content-block content-tool-result"><div class="block-label">${escapeHtml(label)}</div><div class="block-content">${escapeHtml(resultContent)}</div></div>`;
      }
      return `<div class="content-block content-user"><div class="block-label">User</div><div class="block-content">${escapeHtml(JSON.stringify(block, null, 2))}</div></div>`;
    }).join('');
  }
  return `<pre>${escapeHtml(JSON.stringify(content, null, 2))}</pre>`;
}

function formatToolExec(data) {
  const resultText = extractText(data.result);
  return `<div class="content-block content-tool-exec">
    <div class="block-label">‚ö° ${escapeHtml(data.tool_name)}</div>
    <div class="block-content">${escapeHtml(resultText)}</div>
  </div>`;
}

function formatContent(content) {
  if (typeof content === 'string') {
    return `<div class="content-block content-text"><div class="block-label">Text</div><div class="block-content">${escapeHtml(content)}</div></div>`;
  }
  if (Array.isArray(content)) {
    return content.map(block => {
      if (block.type === 'text') {
        return `<div class="content-block content-text"><div class="block-label">Text</div><div class="block-content">${escapeHtml(block.text)}</div></div>`;
      }
      if (block.type === 'thinking') {
        return `<div class="content-block content-thinking"><div class="block-label">Thinking</div><div class="block-content">${escapeHtml(block.thinking)}</div></div>`;
      }
      if (block.type === 'tool_use') {
        return `<div class="content-block content-tool-use"><div class="block-label">Tool: ${escapeHtml(block.name)}</div><pre class="block-content">${escapeHtml(JSON.stringify(block.input, null, 2))}</pre></div>`;
      }
      if (block.type === 'tool_result') {
        const toolName = toolNameMap[block.tool_use_id] || '';
        const label = toolName ? `‚Üê ${toolName}` : 'Tool Result';
        const resultContent = extractText(block.content);
        return `<div class="content-block content-tool-result"><div class="block-label">${escapeHtml(label)}</div><div class="block-content">${escapeHtml(resultContent)}</div></div>`;
      }
      return `<div class="content-block"><pre class="block-content">${escapeHtml(JSON.stringify(block, null, 2))}</pre></div>`;
    }).join('');
  }
  return `<pre>${escapeHtml(JSON.stringify(content, null, 2))}</pre>`;
}

function extractText(content) {
  // Extract text from string or list[TextContent]
  if (typeof content === 'string') return content;
  if (Array.isArray(content)) {
    return content.map(c => c.text || JSON.stringify(c)).join('\n');
  }
  return JSON.stringify(content, null, 2);
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

document.getElementById('detail-close').onclick = () => {
  document.getElementById('detail').classList.remove('active');
  if (selected) d3.selectAll('.node').classed('selected', false);
  selected = null;
};

// Zoom into selected SubGraph node
function zoomIntoSubGraph() {
  if (selected && selected.type === 'sub_graph') {
    enterSubGraph(selected);
    // Close detail panel after zooming
    document.getElementById('detail').classList.remove('active');
    d3.selectAll('.node').classed('selected', false);
    selected = null;
  }
}

// Show meta info
console.log('Graph loaded:', graphData.meta);

// =============================================================================
// SubGraph Navigation System
// =============================================================================

// Stack of graph levels for navigation
const graphStack = [{
  name: 'Main',
  nodes: graphData.nodes,
  edges: graphData.edges,
  meta: graphData.meta
}];
let currentDepth = 0;

// Parse SubGraph internal nodes into viewer format
function parseSubGraphNodes(subGraphData) {
  const nodes = [];
  const nodeMap = subGraphData.nodes || {};

  for (const [id, nodeData] of Object.entries(nodeMap)) {
    if (!nodeData || typeof nodeData !== 'object') continue;

    const data = nodeData.data || {};
    const nodeType = getTypeFromData(data);

    nodes.push({
      id: id,
      type: nodeType,
      label: getLabelFromData(data, nodeType),
      data: data,
      metadata: nodeData.metadata || {},
      timestamp: nodeData.timestamp || 0,
      parent_count: (nodeData.parent_ids || []).length,
      parent_ids: nodeData.parent_ids || []
    });
  }

  return nodes;
}

// Parse SubGraph edges from node parent_ids
function parseSubGraphEdges(subGraphData) {
  const edges = [];
  const nodeMap = subGraphData.nodes || {};

  for (const [id, nodeData] of Object.entries(nodeMap)) {
    if (!nodeData || typeof nodeData !== 'object') continue;

    const parentIds = nodeData.parent_ids || [];
    for (const parentId of parentIds) {
      edges.push({ source: parentId, target: id });
    }
  }

  return edges;
}

// Determine node type from serialized data
function getTypeFromData(data) {
  if (!data || typeof data !== 'object') return 'unknown';

  const type = data.type;
  if (type === 'system_prompt') return 'system_prompt';
  if (type === 'tool_definitions') return 'tool_definitions';
  if (type === 'tool_execution') return 'tool_exec';
  if (type === 'stop_reason') return 'stop_reason';
  if (type === 'sub_graph') return 'sub_graph';

  // Check for message by role
  if (data.role === 'user') return 'message_user';
  if (data.role === 'assistant') return 'message_assistant';

  return 'unknown';
}

// Generate label from serialized data
function getLabelFromData(data, nodeType) {
  if (!data) return '?';

  if (nodeType === 'system_prompt') return 'SYSTEM';
  if (nodeType === 'tool_definitions') {
    const tools = data.tools || [];
    return `TOOLS (${tools.length})`;
  }
  if (nodeType === 'tool_exec') {
    return `‚ö°${data.tool_name || 'exec'}`;
  }
  if (nodeType === 'stop_reason') {
    return `‚óâ ${data.reason || 'stop'}`;
  }
  if (nodeType === 'sub_graph') {
    const depth = data.depth || 0;
    const depthStr = depth > 0 ? `[d=${depth}]` : '';
    return `üîÑ${data.tool_name || 'SubAgent'}${depthStr}`;
  }
  if (nodeType === 'message_user' || nodeType === 'message_assistant') {
    const role = nodeType === 'message_user' ? 'USER' : 'ASST';
    const content = data.content;
    let preview = '';
    if (typeof content === 'string') {
      preview = content.slice(0, 20);
    } else if (Array.isArray(content) && content.length > 0) {
      const first = content[0];
      if (first.type === 'text') preview = (first.text || '').slice(0, 15);
      else if (first.type === 'tool_use') preview = `‚Üí${first.name || 'tool'}`;
      else if (first.type === 'tool_result') preview = '‚Üêresult';
      else preview = '...';
    }
    return `${role}: ${preview}`;
  }

  return '?';
}

// Enter a SubGraph (drill down)
function enterSubGraph(subGraphNode) {
  if (!subGraphNode.data || !subGraphNode.data.nodes) {
    console.warn('SubGraph has no nodes to explore');
    return;
  }

  const subNodes = parseSubGraphNodes(subGraphNode.data);
  const subEdges = parseSubGraphEdges(subGraphNode.data);

  if (subNodes.length === 0) {
    console.warn('SubGraph has no parseable nodes');
    return;
  }

  // Push to stack
  graphStack.push({
    name: subGraphNode.data.tool_name || 'SubAgent',
    nodes: subNodes,
    edges: subEdges,
    systemPrompt: subGraphNode.data.system_prompt,
    summary: subGraphNode.data.summary,
    depth: subGraphNode.data.depth || 0
  });
  currentDepth++;

  // Re-render
  renderCurrentGraph();
  updateBreadcrumb();
}

// Navigate to a specific depth in the stack
function navigateToDepth(depth) {
  if (depth < 0 || depth >= graphStack.length) return;

  // Pop stack until we reach target depth
  while (graphStack.length > depth + 1) {
    graphStack.pop();
  }
  currentDepth = depth;

  // Re-render
  renderCurrentGraph();
  updateBreadcrumb();
}

// Update breadcrumb UI
function updateBreadcrumb() {
  const breadcrumb = document.getElementById('breadcrumb');
  let html = '';

  graphStack.forEach((level, i) => {
    if (i > 0) html += '<span class="sep">‚Ä∫</span>';
    const activeClass = i === currentDepth ? ' active' : '';
    const onclick = i === currentDepth ? '' : `onclick="navigateToDepth(${i})"`;
    html += `<span class="crumb${activeClass}" ${onclick}>${escapeHtml(level.name)}</span>`;
  });

  // Add hint for SubGraph exploration
  const currentLevel = graphStack[currentDepth];
  const hasSubGraphs = currentLevel.nodes.some(n => n.type === 'sub_graph');
  if (hasSubGraphs) {
    html += '<span class="hint">Click SubGraph nodes for zoom button</span>';
  } else if (currentDepth > 0) {
    html += '<span class="hint">Click breadcrumb to navigate back</span>';
  }

  breadcrumb.innerHTML = html;
}

// Render the current graph level
function renderCurrentGraph() {
  const currentLevel = graphStack[currentDepth];
  const nodesData = currentLevel.nodes;
  const edgesData = currentLevel.edges;

  // Clear existing graph
  g.selectAll('*').remove();

  // Rebuild tool_use_id -> tool_name mapping for current level
  const localToolNameMap = {};
  nodesData.forEach(n => {
    if (n.data && n.data.content && Array.isArray(n.data.content)) {
      n.data.content.forEach(block => {
        if (block.type === 'tool_use' && block.id && block.name) {
          localToolNameMap[block.id] = block.name;
        }
      });
    }
  });
  // Merge with global map
  Object.assign(toolNameMap, localToolNameMap);

  // Build dagre graph
  const newDagreGraph = new dagre.graphlib.Graph();
  newDagreGraph.setGraph({ rankdir: 'TB', nodesep: 50, ranksep: 60, marginx: 20, marginy: 20 });
  newDagreGraph.setDefaultEdgeLabel(() => ({}));

  // Add nodes
  nodesData.forEach(n => {
    newDagreGraph.setNode(n.id, { width: nodeWidth, height: nodeHeight, data: n });
  });

  // Add edges
  edgesData.forEach(e => {
    newDagreGraph.setEdge(e.source, e.target);
  });

  // Layout
  dagre.layout(newDagreGraph);

  // Get positions
  const newNodeMap = new Map();
  newDagreGraph.nodes().forEach(id => {
    const node = newDagreGraph.node(id);
    if (node && node.data) {
      node.data.x = node.x;
      node.data.y = node.y;
      newNodeMap.set(id, node.data);
    }
  });

  // Compute bounds and set viewBox
  const xs = nodesData.map(n => n.x).filter(x => x !== undefined);
  const ys = nodesData.map(n => n.y).filter(y => y !== undefined);

  if (xs.length === 0 || ys.length === 0) {
    // No positioned nodes
    svg.attr('viewBox', '0 0 400 300');
    return;
  }

  const minX = Math.min(...xs) - nodeWidth;
  const maxX = Math.max(...xs) + nodeWidth;
  const minY = Math.min(...ys) - nodeHeight;
  const maxY = Math.max(...ys) + nodeHeight;
  svg.attr('viewBox', `${minX} ${minY} ${maxX - minX} ${maxY - minY}`);

  // Draw edges with curves
  g.selectAll('.edge')
    .data(edgesData.filter(d => newNodeMap.has(d.source) && newNodeMap.has(d.target)))
    .join('path')
    .attr('class', 'edge')
    .attr('marker-end', 'url(#arrow)')
    .attr('d', d => {
      const source = newNodeMap.get(d.source);
      const target = newNodeMap.get(d.target);
      const sy = source.y + nodeHeight/2;
      const ty = target.y - nodeHeight/2;
      const midY = (sy + ty) / 2;
      return `M${source.x},${sy} C${source.x},${midY} ${target.x},${midY} ${target.x},${ty}`;
    });

  // Draw nodes
  const newNodes = g.selectAll('.node')
    .data(nodesData.filter(n => n.x !== undefined))
    .join('g')
    .attr('class', d => `node type-${d.type}`)
    .attr('transform', d => `translate(${d.x - nodeWidth/2},${d.y - nodeHeight/2})`)
    .on('click', (e, d) => showDetail(d));

  newNodes.append('rect')
    .attr('width', nodeWidth)
    .attr('height', nodeHeight)
    .attr('rx', 6);

  newNodes.append('text')
    .attr('x', nodeWidth / 2)
    .attr('y', nodeHeight / 2 + 4)
    .attr('text-anchor', 'middle')
    .text(d => d.label.length > 18 ? d.label.slice(0, 16) + '...' : d.label);
}

// Initialize breadcrumb
updateBreadcrumb();
</script>
</body>
</html>
